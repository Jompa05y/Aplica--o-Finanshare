import React, { useState, useEffect } from "react";
import { Expense } from "@/entities/Expense";
import { Debt } from "@/entities/Debt";
import { User } from "@/entities/User";
import { BarChart, Bar, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from "recharts";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { useToast } from "@/components/ui/use-toast";
import { TrendingUp, TrendingDown, PieChart as PieChartIcon, Users, DollarSign, Download, AlertTriangle, Target } from "lucide-react";
import { subDays, startOfMonth, startOfYear, format, subMonths } from "date-fns";
import { ptBR } from "date-fns/locale";

const COLORS = ['#10B981', '#3B82F6', '#8B5CF6', '#F59E0B', '#EF4444', '#6B7280', '#EC4899', '#8B5A2B'];

const categories = {
  "alimentacao": { label: "Alimenta√ß√£o", emoji: "üçΩÔ∏è" },
  "moradia": { label: "Moradia", emoji: "üè†" },
  "transporte": { label: "Transporte", emoji: "üöó" },
  "lazer": { label: "Lazer", emoji: "üéÆ" },
  "saude": { label: "Sa√∫de", emoji: "‚öïÔ∏è" },
  "educacao": { label: "Educa√ß√£o", emoji: "üìö" },
  "vestuario": { label: "Vestu√°rio", emoji: "üëï" },
  "outros": { label: "Outros", emoji: "üí∞" }
};

export default function Reports() {
  const [user, setUser] = useState(null);
  const [allExpenses, setAllExpenses] = useState([]);
  const [debts, setDebts] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [period, setPeriod] = useState("month");
  const { toast } = useToast();

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    const userData = await User.me();
    setUser(userData);
    const userExpenses = await Expense.filter({ created_by: userData.email }, "-date");
    const userDebts = await Debt.filter({ created_by: userData.email });
    setAllExpenses(userExpenses);
    setDebts(userDebts);
    setIsLoading(false);
  };
  
  const getFilteredExpenses = () => {
    const now = new Date();
    let startDate;
    switch(period) {
        case 'week': startDate = subDays(now, 7); break;
        case 'year': startDate = startOfYear(now); break;
        case 'month':
        default: startDate = startOfMonth(now); break;
    }
    return allExpenses.filter(e => new Date(e.date) >= startDate);
  };

  const getPreviousPeriodExpenses = () => {
    const now = new Date();
    let startDate, endDate;
    switch(period) {
        case 'week': 
            startDate = subDays(now, 14);
            endDate = subDays(now, 7);
            break;
        case 'year': 
            startDate = subMonths(startOfYear(now), 12);
            endDate = startOfYear(now);
            break;
        case 'month':
        default: 
            startDate = subMonths(startOfMonth(now), 1);
            endDate = startOfMonth(now);
            break;
    }
    return allExpenses.filter(e => {
        const expenseDate = new Date(e.date);
        return expenseDate >= startDate && expenseDate < endDate;
    });
  };
  
  const filteredExpenses = getFilteredExpenses();
  const previousPeriodExpenses = getPreviousPeriodExpenses();
  const totalSpent = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
  const previousTotal = previousPeriodExpenses.reduce((sum, e) => sum + e.amount, 0);
  const percentChange = previousTotal > 0 ? ((totalSpent - previousTotal) / previousTotal) * 100 : 0;

  const categoryData = Object.keys(categories).map(cat => ({
      category: cat,
      name: categories[cat].label,
      emoji: categories[cat].emoji,
      value: filteredExpenses.filter(e => e.category === cat).reduce((sum, e) => sum + e.amount, 0),
      count: filteredExpenses.filter(e => e.category === cat).length
  })).filter(d => d.value > 0).sort((a, b) => b.value - a.value);

  const personalVsGroupData = [
      { 
          name: 'Pessoal', 
          value: filteredExpenses.filter(e => !e.is_group_expense).reduce((sum, e) => sum + e.amount, 0),
          fill: COLORS[0]
      },
      { 
          name: 'Grupo', 
          value: filteredExpenses.filter(e => e.is_group_expense).reduce((sum, e) => sum + e.amount, 0),
          fill: COLORS[1]
      }
  ];

  const monthlyTrend = () => {
    const last6Months = [];
    for (let i = 5; i >= 0; i--) {
        const date = subMonths(new Date(), i);
        const monthStart = startOfMonth(date);
        const monthEnd = new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 0);
        
        const monthExpenses = allExpenses.filter(e => {
            const expenseDate = new Date(e.date);
            return expenseDate >= monthStart && expenseDate <= monthEnd;
        });
        
        last6Months.push({
            month: format(date, 'MMM/yy', { locale: ptBR }),
            total: monthExpenses.reduce((sum, e) => sum + e.amount, 0),
            personal: monthExpenses.filter(e => !e.is_group_expense).reduce((sum, e) => sum + e.amount, 0),
            group: monthExpenses.filter(e => e.is_group_expense).reduce((sum, e) => sum + e.amount, 0)
        });
    }
    return last6Months;
  };

  const exportToCSV = (data, filename) => {
    const csvContent = "data:text/csv;charset=utf-8," 
        + "T√≠tulo,Valor,Categoria,Data,Tipo,Descri√ß√£o\n"
        + data.map(item => 
            `"${item.title}","R$ ${item.amount.toLocaleString('pt-BR')}","${categories[item.category]?.label || item.category}","${format(new Date(item.date), 'dd/MM/yyyy')}","${item.is_group_expense ? 'Grupo' : 'Pessoal'}","${item.description || ''}"`
        ).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `${filename}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    toast({
        title: "Exporta√ß√£o realizada!",
        description: `Arquivo ${filename}.csv baixado com sucesso.`
    });
  };

  const exportDebtsToCSV = () => {
    const csvContent = "data:text/csv;charset=utf-8," 
        + "T√≠tulo,Valor,Vencimento,Status,Tipo\n"
        + debts.map(debt => 
            `"${debt.title}","R$ ${debt.amount.toLocaleString('pt-BR')}","${format(new Date(debt.due_date), 'dd/MM/yyyy')}","${debt.status === 'paid' ? 'Pago' : 'Pendente'}","${debt.type}"`
        ).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "dividas.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    toast({
        title: "Exporta√ß√£o realizada!",
        description: "Arquivo dividas.csv baixado com sucesso."
    });
  };

  if (isLoading) {
    return <div className="p-4 max-w-md mx-auto">Carregando relat√≥rios...</div>;
  }

  return (
    <div className="p-4 max-w-md mx-auto">
      <div className="mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Relat√≥rios</h1>
        <p className="text-gray-600">An√°lises detalhadas dos seus gastos.</p>
      </div>

      <div className="flex gap-3 mb-6">
        <Select value={period} onValueChange={setPeriod}>
          <SelectTrigger className="flex-1">
            <SelectValue placeholder="Selecione o per√≠odo"/>
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="month">Este M√™s</SelectItem>
            <SelectItem value="week">√öltimos 7 dias</SelectItem>
            <SelectItem value="year">Este Ano</SelectItem>
          </SelectContent>
        </Select>
        
        <Button variant="outline" onClick={() => exportToCSV(filteredExpenses, `gastos-${period}`)}>
          <Download className="w-4 h-4" />
        </Button>
      </div>

      <div className="space-y-6">
        {/* Resumo com Varia√ß√£o */}
        <Card className="bg-gradient-to-r from-emerald-500 to-blue-500 text-white">
            <CardHeader><CardTitle className="text-lg">Resumo do Per√≠odo</CardTitle></CardHeader>
            <CardContent className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                    <div className="text-center">
                        <p className="text-sm opacity-90">Total Gasto</p>
                        <p className="text-2xl font-bold">R$ {totalSpent.toLocaleString('pt-BR')}</p>
                        <div className="flex items-center justify-center mt-1">
                            {percentChange > 0 ? (
                                <><TrendingUp className="w-4 h-4 mr-1" /><span className="text-sm">+{percentChange.toFixed(1)}%</span></>
                            ) : percentChange < 0 ? (
                                <><TrendingDown className="w-4 h-4 mr-1" /><span className="text-sm">{percentChange.toFixed(1)}%</span></>
                            ) : (
                                <span className="text-sm">Sem varia√ß√£o</span>
                            )}
                        </div>
                    </div>
                    <div className="text-center">
                        <p className="text-sm opacity-90">Transa√ß√µes</p>
                        <p className="text-2xl font-bold">{filteredExpenses.length}</p>
                        <p className="text-sm opacity-75">M√©dia: R$ {(totalSpent / (filteredExpenses.length || 1)).toLocaleString('pt-BR')}</p>
                    </div>
                </div>
                
                {user.monthly_budget && (
                    <div className="bg-white/20 backdrop-blur-sm rounded-lg p-4 shadow-md">
                        <div className="flex items-center justify-between mb-2">
                            <div className="flex items-center gap-2">
                                <Target className="w-5 h-5 text-white" />
                                <span className="text-sm font-semibold text-white">Meta do Or√ßamento</span>
                            </div>
                            <Badge 
                                className={`${
                                    totalSpent > user.monthly_budget 
                                        ? 'bg-red-500 text-white' 
                                        : 'bg-green-500 text-white'
                                } font-bold text-sm px-3 py-1`}
                            >
                                {((totalSpent / user.monthly_budget) * 100).toFixed(0)}%
                            </Badge>
                        </div>
                        <div className="w-full bg-white/30 rounded-full h-3 mt-2 shadow-inner">
                            <div 
                                className={`h-3 rounded-full transition-all duration-300 shadow-md ${
                                    totalSpent > user.monthly_budget 
                                        ? 'bg-gradient-to-r from-red-400 to-red-600' 
                                        : 'bg-gradient-to-r from-green-300 to-green-500'
                                }`}
                                style={{ width: `${Math.min((totalSpent / user.monthly_budget) * 100, 100)}%` }}
                            />
                        </div>
                        <div className="flex justify-between mt-2 text-xs text-white font-medium">
                            <span>R$ {totalSpent.toLocaleString('pt-BR')}</span>
                            <span>R$ {user.monthly_budget.toLocaleString('pt-BR')}</span>
                        </div>
                    </div>
                )}
            </CardContent>
        </Card>

        {/* Top Categorias com Insights */}
        <Card>
            <CardHeader className="flex flex-row items-center justify-between">
                <CardTitle className="text-lg flex items-center gap-2">
                    <PieChartIcon className="w-5 h-5" /> Top Categorias
                </CardTitle>
                {categoryData.length > 3 && (
                    <Badge variant="outline">
                        <AlertTriangle className="w-3 h-3 mr-1" />
                        Diversificado
                    </Badge>
                )}
            </CardHeader>
            <CardContent>
                <div className="space-y-3">
                    {categoryData.slice(0, 5).map((cat, index) => (
                        <div key={cat.category} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div className="flex items-center gap-3">
                                <div className="text-2xl">{cat.emoji}</div>
                                <div>
                                    <p className="font-semibold">{cat.name}</p>
                                    <p className="text-sm text-gray-500">{cat.count} transa√ß√µes</p>
                                </div>
                            </div>
                            <div className="text-right">
                                <p className="font-bold text-lg">R$ {cat.value.toLocaleString('pt-BR')}</p>
                                <p className="text-sm text-gray-500">{((cat.value/totalSpent)*100).toFixed(1)}%</p>
                            </div>
                        </div>
                    ))}
                </div>
            </CardContent>
        </Card>

        {/* Gr√°fico de Pizza Melhorado */}
        <Card>
            <CardHeader><CardTitle className="text-lg">Distribui√ß√£o dos Gastos</CardTitle></CardHeader>
            <CardContent className="h-80">
                <ResponsiveContainer width="100%" height="100%">
                    <PieChart>
                        <Pie 
                            data={categoryData} 
                            dataKey="value" 
                            nameKey="name" 
                            cx="50%" 
                            cy="50%" 
                            outerRadius={80}
                            innerRadius={40}
                            label={({name, percent}) => `${name}: ${(percent * 100).toFixed(0)}%`}
                            labelLine={false}
                        >
                             {categoryData.map((entry, index) => (
                                <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                             ))}
                        </Pie>
                        <Tooltip 
                            formatter={(value) => [`R$ ${Number(value).toLocaleString('pt-BR')}`, 'Valor']}
                            labelFormatter={(name) => `Categoria: ${name}`}
                        />
                    </PieChart>
                </ResponsiveContainer>
            </CardContent>
        </Card>

        {/* Pessoal vs Grupo */}
        <Card>
            <CardHeader><CardTitle className="text-lg flex items-center gap-2"><Users/> Pessoal vs. Grupo</CardTitle></CardHeader>
            <CardContent className="h-64">
                <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={personalVsGroupData} layout="vertical">
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis type="number" tickFormatter={(value) => `R$ ${(value/1000).toFixed(0)}k`} />
                        <YAxis type="category" dataKey="name" width={60} />
                        <Tooltip formatter={(value) => [`R$ ${Number(value).toLocaleString('pt-BR')}`, 'Total']}/>
                        <Bar dataKey="value" radius={[0, 4, 4, 0]}>
                            {personalVsGroupData.map((entry, index) => (
                                <Cell key={`cell-${index}`} fill={entry.fill} />
                            ))}
                        </Bar>
                    </BarChart>
                </ResponsiveContainer>
            </CardContent>
        </Card>

        {/* Tend√™ncia de 6 Meses */}
        <Card>
            <CardHeader><CardTitle className="text-lg flex items-center gap-2"><TrendingUp/> Tend√™ncia (√öltimos 6 Meses)</CardTitle></CardHeader>
            <CardContent className="h-64">
                 <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={monthlyTrend()}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="month" />
                        <YAxis tickFormatter={(value) => `R$ ${(value/1000).toFixed(0)}k`} />
                        <Tooltip formatter={(value) => `R$ ${Number(value).toLocaleString('pt-BR')}`}/>
                        <Legend />
                        <Line type="monotone" dataKey="total" stroke="#10B981" strokeWidth={3} name="Total" />
                        <Line type="monotone" dataKey="personal" stroke="#3B82F6" strokeWidth={2} name="Pessoal" strokeDasharray="5 5" />
                        <Line type="monotone" dataKey="group" stroke="#8B5CF6" strokeWidth={2} name="Grupo" strokeDasharray="5 5" />
                    </LineChart>
                </ResponsiveContainer>
            </CardContent>
        </Card>

        {/* Exporta√ß√µes */}
        <Card>
            <CardHeader><CardTitle className="text-lg flex items-center gap-2"><Download /> Exportar Dados</CardTitle></CardHeader>
            <CardContent className="grid grid-cols-2 gap-4">
                <Button variant="outline" onClick={() => exportToCSV(allExpenses, 'todos-gastos')}>
                    <Download className="w-4 h-4 mr-2" />
                    Todos os Gastos
                </Button>
                <Button variant="outline" onClick={exportDebtsToCSV}>
                    <Download className="w-4 h-4 mr-2" />
                    Minhas D√≠vidas
                </Button>
            </CardContent>
        </Card>
      </div>
    </div>
  );
}