import React, { useState, useEffect, useCallback } from "react";
import { useLocation, useNavigate, Link } from "react-router-dom";
import { Group } from "@/entities/Group";
import { Expense } from "@/entities/Expense";
import { User } from "@/entities/User";
import { createPageUrl } from "@/utils";
import { 
  ArrowLeft, 
  Users, 
  Plus, 
  Copy, 
  BarChart3, 
  Crown,
  Trash2,
  List,
  ShieldAlert,
  Edit, // Adicionar Edit
  User as UserIcon,
  TrendingDown
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { toast } from "@/components/ui/use-toast";
import { format } from "date-fns";
import { ptBR } from "date-fns/locale";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog";

const COLORS = ['#10B981', '#3B82F6', '#8B5CF6', '#F59E0B', '#EF4444', '#6B7280'];

export default function GroupDetail() {
  const navigate = useNavigate();
  const location = useLocation();
  const [user, setUser] = useState(null);
  const [group, setGroup] = useState(null);
  const [expenses, setExpenses] = useState([]);
  const [balances, setBalances] = useState({});
  const [isLoading, setIsLoading] = useState(true);
  const [view, setView] = useState("expenses"); // 'expenses', 'balance', 'members'

  const calculateBalance = useCallback((groupData, groupExpenses) => {
    if (!groupData || !groupData.admin_email) return;

    const memberEmails = [groupData.admin_email, ...(groupData.members || []).map(m => m.email)];
    const balanceSheet = {};

    // Initialize balance sheet for all known members
    memberEmails.forEach(email => {
        balanceSheet[email] = { paid: 0, owed: 0, balance: 0 };
    });

    groupExpenses.forEach(expense => {
        // Amount paid by the payer
        if(balanceSheet[expense.paid_by]) {
            balanceSheet[expense.paid_by].paid += expense.amount;
        }

        // Amount owed by each member in split_between
        const numMembers = expense.split_between?.length || 1;
        const share = expense.amount / numMembers;
        expense.split_between?.forEach(email => {
            if(balanceSheet[email]) {
                balanceSheet[email].owed += share;
            }
        });
    });

    // Calculate final balance for each member
    Object.keys(balanceSheet).forEach(email => {
        balanceSheet[email].balance = balanceSheet[email].paid - balanceSheet[email].owed;
    });

    setBalances(balanceSheet);
  }, []);

  const loadData = useCallback(async (groupId) => {
    try {
      const userData = await User.me();
      setUser(userData);

      const groupData = await Group.get(groupId);
      setGroup(groupData);

      const groupExpenses = await Expense.filter({ group_id: groupId }, "-date");
      setExpenses(groupExpenses);

      calculateBalance(groupData, groupExpenses);
    } catch (error) {
      console.error("Erro ao carregar dados do grupo:", error);
      toast({
        title: "Erro",
        description: "Não foi possível carregar os dados do grupo.",
        variant: "destructive",
      });
      if (error.response && error.response.status === 404) {
        navigate(createPageUrl("Groups"));
      }
    }
    setIsLoading(false);
  }, [calculateBalance, navigate]);
  
  useEffect(() => {
    const params = new URLSearchParams(location.search);
    const groupId = params.get("id");
    if (groupId) {
      loadData(groupId);
    }
  }, [location.search, loadData]);

  const deleteGroup = async () => {
    try {
      await Group.delete(group.id);
      toast({ title: "Grupo deletado com sucesso!" });
      navigate(createPageUrl("Groups"));
    } catch (error) {
      console.error("Erro ao deletar grupo:", error);
      toast({ title: "Erro ao deletar grupo", description: "Verifique sua conexão ou tente novamente.", variant: "destructive" });
    }
  };

  const copyInviteCode = async (code) => {
    await navigator.clipboard.writeText(code);
    toast({
      title: "Código copiado!",
      description: "O código de convite foi copiado para a área de transferência.",
    });
  };

  if (isLoading) {
    return <div className="p-4 max-w-md mx-auto">Carregando...</div>;
  }

  if (!group) {
    return <div className="p-4 max-w-md mx-auto">Grupo não encontrado.</div>;
  }

  const isAdmin = user?.email === group.admin_email;
  const totalExpenses = expenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
  
  // Consolidate all members for display
  const allMembers = [
      { email: group.admin_email, name: group.admin_name || 'Admin', joined_date: group.created_date }, // Admin with created_date as joined_date
      ...(group.members || [])
  ];

  return (
    <div className="p-4 max-w-md mx-auto">
      {/* Header */}
      <div className="flex items-center gap-4 mb-6">
        <Button 
          variant="ghost" 
          size="icon"
          onClick={() => navigate(createPageUrl("Groups"))}
        >
          <ArrowLeft className="w-5 h-5" />
        </Button>
        <div>
          <h1 className="text-xl font-bold text-gray-800 truncate">{group.name}</h1>
          <p className="text-sm text-gray-600 truncate">{group.description}</p>
        </div>
      </div>

      {/* Group Stats */}
      <div className="grid grid-cols-2 gap-4 mb-6">
        <Card className="bg-gradient-to-r from-red-500 to-red-600 text-white">
          <CardContent className="p-4">
            <TrendingDown className="w-6 h-6 mb-2" />
            <p className="text-sm opacity-90">Total Gasto</p>
            <p className="text-2xl font-bold">R$ {totalExpenses.toLocaleString('pt-BR')}</p>
          </CardContent>
        </Card>
        <Card className="bg-gradient-to-r from-blue-500 to-blue-600 text-white">
          <CardContent className="p-4">
            <Users className="w-6 h-6 mb-2" />
            <p className="text-sm opacity-90">Membros</p>
            <p className="text-2xl font-bold">{(group.members?.length || 0) + 1}</p>
          </CardContent>
        </Card>
      </div>

      {/* Actions */}
      <div className="flex gap-3 mb-6">
        <Link to={createPageUrl(`AddExpense?groupId=${group.id}`)} className="flex-1">
          <Button className="w-full bg-emerald-600 hover:bg-emerald-700 text-white">
            <Plus className="w-4 h-4 mr-2" />
            Nova Despesa
          </Button>
        </Link>
        <Button variant="outline" className="flex-1" onClick={() => copyInviteCode(group.invite_code)}>
          <Copy className="w-4 h-4 mr-2" />
          Convidar
        </Button>
      </div>
      
      {/* View Toggle */}
      <div className="grid grid-cols-3 bg-gray-100 p-1 rounded-lg mb-4">
        <Button onClick={() => setView('expenses')} variant={view === 'expenses' ? 'default' : 'ghost'} className={`flex-1 text-xs sm:text-sm ${view === 'expenses' ? 'text-white' : ''}`}>
          <List className="w-4 h-4 mr-1" /> Despesas
        </Button>
        <Button onClick={() => setView('balance')} variant={view === 'balance' ? 'default' : 'ghost'} className="flex-1 text-xs sm:text-sm">
          <BarChart3 className="w-4 h-4 mr-1" /> Balanço
        </Button>
        <Button onClick={() => setView('members')} variant={view === 'members' ? 'default' : 'ghost'} className="flex-1 text-xs sm:text-sm">
          <Users className="w-4 h-4 mr-1" /> Membros
        </Button>
      </div>

      {/* Content based on view */}
      {view === 'expenses' && (
        <Card>
          <CardHeader>
            <CardTitle>Últimas Despesas</CardTitle>
          </CardHeader>
          <CardContent>
            {expenses.length === 0 ? (
              <p className="text-gray-500 text-center py-4">Nenhuma despesa neste grupo ainda.</p>
            ) : (
              <div className="space-y-3">
                {expenses.map(expense => (
                  <div key={expense.id} className="flex items-center gap-3">
                    <div className="flex-1">
                      <p className="font-medium">{expense.title}</p>
                      <p className="text-xs text-gray-500">
                        {format(new Date(expense.date), "dd/MM/yy", { locale: ptBR })} - Pago por {
                          allMembers.find(m => m.email === expense.paid_by)?.name || expense.paid_by.split('@')[0]
                        }
                      </p>
                    </div>
                    <p className="font-bold mr-2">R$ {expense.amount.toLocaleString('pt-BR')}</p>
                    <Link to={createPageUrl(`AddExpense?id=${expense.id}`)}>
                      <Button variant="ghost" size="icon" className="h-8 w-8">
                        <Edit className="w-4 h-4 text-gray-500" />
                      </Button>
                    </Link>
                  </div>
                ))}
              </div>
            )}
          </CardContent>
        </Card>
      )}

      {view === 'balance' && (
        <Card>
          <CardHeader><CardTitle>Balanço do Grupo</CardTitle></CardHeader>
          <CardContent>
            <div className="space-y-3">
              {Object.entries(balances).map(([email, data]) => {
                const member = allMembers.find(m => m.email === email);
                return (
                  <div key={email} className="flex items-center justify-between p-2 rounded-md hover:bg-gray-50">
                    <p className="font-medium text-sm">{member?.name || email.split('@')[0]}</p>
                    <Badge variant={data.balance >= 0 ? "default" : "destructive"} className="text-white">
                      {data.balance >= 0 ? 'Recebe' : 'Deve'} R$ {Math.abs(data.balance).toLocaleString('pt-BR')}
                    </Badge>
                  </div>
                )
              })}
            </div>
          </CardContent>
        </Card>
      )}

      {view === 'members' && (
        <Card>
          <CardHeader><CardTitle>Membros do Grupo</CardTitle></CardHeader>
          <CardContent>
            <div className="space-y-3">
              {allMembers.map(member => (
                <div key={member.email} className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                     <div className="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                        <UserIcon className="w-4 h-4 text-gray-600" />
                     </div>
                     <div>
                        <p className="font-medium text-sm">{member.name || member.email.split('@')[0]}</p>
                        <p className="text-xs text-gray-500">Entrou em {format(new Date(member.joined_date), "dd/MM/yy", { locale: ptBR })}</p>
                     </div>
                  </div>
                  {member.email === group.admin_email && (
                    <Badge variant="secondary"><Crown className="w-3 h-3 mr-1"/>Admin</Badge>
                  )}
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      )}

      {isAdmin && (
        <Card className="mt-6 border-red-200 bg-red-50">
          <CardHeader>
            <CardTitle className="text-lg text-red-800 flex items-center gap-2">
              <ShieldAlert className="w-5 h-5" /> Zona de Perigo
            </CardTitle>
          </CardHeader>
          <CardContent className="flex justify-between items-center">
            <p className="text-sm text-red-700">Deletar este grupo e todos os seus dados.</p>
            <AlertDialog>
              <AlertDialogTrigger asChild>
                <Button variant="destructive" size="sm">
                  <Trash2 className="w-4 h-4 mr-1" /> Deletar
                </Button>
              </AlertDialogTrigger>
              <AlertDialogContent>
                <AlertDialogHeader>
                  <AlertDialogTitle>Você tem certeza?</AlertDialogTitle>
                  <AlertDialogDescription>
                    Esta ação não pode ser desfeita. Isso irá deletar permanentemente o grupo "{group.name}" e todas as suas despesas.
                  </AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                  <AlertDialogCancel>Cancelar</AlertDialogCancel>
                  <AlertDialogAction onClick={deleteGroup} className="bg-red-600 hover:bg-red-700 text-white">
                    Sim, deletar grupo
                  </AlertDialogAction>
                </AlertDialogFooter>
              </AlertDialogContent>
            </AlertDialog>
          </CardContent>
        </Card>
      )}
    </div>
  );
}